<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Messenger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .header {
            background: #2C3E50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .tabs {
            display: flex;
            background: #34495E;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #3498DB;
            background: #2C3E50;
        }
        
        .tab-content {
            display: none;
            height: 500px;
            flex-direction: column;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        /* –û–±—â–∏–π —á–∞—Ç */
        .messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #ECF0F1;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 10px;
            background: white;
            max-width: 80%;
        }
        
        .message.own {
            background: #3498DB;
            color: white;
            margin-left: auto;
        }
        
        .message-system {
            text-align: center;
            color: #7F8C8D;
            font-style: italic;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            gap: 10px;
            background: white;
            border-top: 1px solid #BDC3C7;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #BDC3C7;
            border-radius: 20px;
            outline: none;
        }
        
        .send-btn {
            background: #27AE60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
        }
        
        /* –ö–æ–Ω—Ç–∞–∫—Ç—ã */
        .contacts-list {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .contact {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #E1E8ED;
            cursor: pointer;
        }
        
        .contact:hover {
            background: #F8F9FA;
        }
        
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498DB;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-name {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .contact-status {
            font-size: 12px;
            color: #7F8C8D;
        }
        
        .contact-online {
            color: #27AE60;
        }
        
        .contact-actions {
            display: flex;
            gap: 5px;
        }
        
        .call-btn {
            background: #27AE60;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* –ó–∞—è–≤–∫–∏ */
        .requests-list {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .request {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid #E1E8ED;
        }
        
        .request-info {
            margin-bottom: 10px;
        }
        
        .request-actions {
            display: flex;
            gap: 10px;
        }
        
        .accept-btn {
            background: #27AE60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            flex: 1;
        }
        
        .decline-btn {
            background: #E74C3C;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            flex: 1;
        }
        
        /* –ü–æ–∏—Å–∫ */
        .search-container {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #E1E8ED;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #BDC3C7;
            border-radius: 20px;
            outline: none;
        }
        
        .add-user-btn {
            background: #3498DB;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        
        /* –õ–æ–≥–∏–Ω */
        .login-screen {
            padding: 40px 20px;
            text-align: center;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #DDD;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 16px;
            text-align: center;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: #27AE60;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .hidden {
            display: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2C3E50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üí¨ Secure Messenger</h2>
            <div id="status">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞ -->
        <div class="login-screen" id="loginScreen">
            <h3>–í—Ö–æ–¥ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h3>
            <input type="text" id="usernameInput" class="login-input" placeholder="–í–∞—à–µ –∏–º—è" value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
            <button onclick="login()" class="login-btn">–í–æ–π—Ç–∏</button>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="mainApp" class="hidden">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('chat')">üí¨ –ß–∞—Ç</div>
                <div class="tab" onclick="switchTab('contacts')">üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
                <div class="tab" onclick="switchTab('requests')">üì® –ó–∞—è–≤–∫–∏</div>
            </div>
            
            <!-- –û–±—â–∏–π —á–∞—Ç -->
            <div class="tab-content active" id="chatTab">
                <div class="messages" id="messages">
                    <div class="message-system">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ–±—â–∏–π —á–∞—Ç!</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" class="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button onclick="sendMessage()" class="send-btn">‚û§</button>
                </div>
            </div>
            
            <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
            <div class="tab-content" id="contactsTab">
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
                    <button onclick="sendRequest()" class="add-user-btn">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                </div>
                <div class="contacts-list" id="contactsList">
                    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
                </div>
            </div>
            
            <!-- –ó–∞—è–≤–∫–∏ -->
            <div class="tab-content" id="requestsTab">
                <div class="requests-list" id="requestsList">
                    <!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJHA9xBK-yO0giaxITea2ckejnuPvwos",
            authDomain: "my-github-messenger.firebaseapp.com",
            databaseURL: "https://my-github-messenger-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "my-github-messenger",
            storageBucket: "my-github-messenger.firebasestorage.app",
            messagingSenderId: "555869914189",
            appId: "1:555869914189:web:2acc7882e5b24598f14804"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let currentUser = null;
        let contacts = [];
        let requests = [];

        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
            
            currentUser = {
                id: 'user_' + Date.now(),
                name: username,
                online: true,
                lastSeen: Date.now()
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            database.ref('users/' + currentUser.id).set({
                name: currentUser.name,
                online: true,
                lastSeen: Date.now()
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('status').textContent = '‚úÖ –û–Ω–ª–∞–π–Ω';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadMessages();
            loadContacts();
            loadRequests();
            
            // –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            setupListeners();
        }

        function setupListeners() {
            // –°–æ–æ–±—â–µ–Ω–∏—è
            database.ref('messages').limitToLast(100).on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
            });
            
            // –ö–æ–Ω—Ç–∞–∫—Ç—ã
            database.ref('users').on('value', (snapshot) => {
                updateContacts(snapshot.val());
            });
            
            // –ó–∞—è–≤–∫–∏
            database.ref('requests').on('value', (snapshot) => {
                updateRequests(snapshot.val());
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å
            setInterval(() => {
                if (currentUser) {
                    database.ref('users/' + currentUser.id).update({
                        lastSeen: Date.now(),
                        online: true
                    });
                }
            }, 30000);
        }

        function loadMessages() {
            database.ref('messages').limitToLast(50).once('value', (snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    Object.values(messages).forEach(message => {
                        displayMessage(message);
                    });
                }
            });
        }

        function displayMessage(message) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            if (message.type === 'system') {
                messageDiv.className = 'message-system';
                messageDiv.textContent = message.text;
            } else {
                messageDiv.className = `message ${message.userId === currentUser.id ? 'own' : ''}`;
                messageDiv.innerHTML = `
                    <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">
                        ${message.userName}
                    </div>
                    <div>${message.text}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messages.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentUser) return;
            
            const message = {
                userId: currentUser.id,
                userName: currentUser.name,
                text: text,
                timestamp: Date.now(),
                type: 'user'
            };
            
            database.ref('messages').push(message);
            input.value = '';
        }

        function loadContacts() {
            database.ref('users').once('value', (snapshot) => {
                updateContacts(snapshot.val());
            });
        }

        function updateContacts(users) {
            if (!users) return;
            
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';
            
            Object.entries(users).forEach(([userId, user]) => {
                if (userId === currentUser.id) return;
                
                const isOnline = user.online && (Date.now() - user.lastSeen < 40000);
                
                const contactDiv = document.createElement('div');
                contactDiv.className = 'contact';
                contactDiv.innerHTML = `
                    <div class="contact-avatar">${user.name.charAt(0)}</div>
                    <div class="contact-info">
                        <div class="contact-name">${user.name}</div>
                        <div class="contact-status ${isOnline ? 'contact-online' : ''}">
                            ${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : '‚ö´ –û—Ñ–ª–∞–π–Ω'}
                        </div>
                    </div>
                    <div class="contact-actions">
                        <button class="call-btn" onclick="startCall('${userId}')">üìû</button>
                    </div>
                `;
                
                contactsList.appendChild(contactDiv);
            });
        }

        function loadRequests() {
            database.ref('requests').once('value', (snapshot) => {
                updateRequests(snapshot.val());
            });
        }

        function updateRequests(requestsData) {
            if (!requestsData) return;
            
            const requestsList = document.getElementById('requestsList');
            requestsList.innerHTML = '';
            
            Object.entries(requestsData).forEach(([requestId, request]) => {
                if (request.toUserId === currentUser.id && request.status === 'pending') {
                    const requestDiv = document.createElement('div');
                    requestDiv.className = 'request';
                    requestDiv.innerHTML = `
                        <div class="request-info">
                            <strong>${request.fromUserName}</strong> —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã
                        </div>
                        <div class="request-actions">
                            <button class="accept-btn" onclick="acceptRequest('${requestId}')">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                            <button class="decline-btn" onclick="declineRequest('${requestId}')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    `;
                    
                    requestsList.appendChild(requestDiv);
                }
            });
        }

        function sendRequest() {
            const searchInput = document.getElementById('searchInput');
            const username = searchInput.value.trim();
            
            if (!username) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
            if (username === currentUser.name) return alert('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è!');
            
            // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            database.ref('users').once('value', (snapshot) => {
                const users = snapshot.val();
                let foundUser = null;
                
                Object.entries(users).forEach(([userId, user]) => {
                    if (user.name === username && userId !== currentUser.id) {
                        foundUser = { id: userId, ...user };
                    }
                });
                
                if (foundUser) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É
                    const request = {
                        fromUserId: currentUser.id,
                        fromUserName: currentUser.name,
                        toUserId: foundUser.id,
                        toUserName: foundUser.name,
                        status: 'pending',
                        timestamp: Date.now()
                    };
                    
                    database.ref('requests').push(request);
                    searchInput.value = '';
                    showNotification(`–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${username}`);
                } else {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                }
            });
        }

        function acceptRequest(requestId) {
            database.ref('requests/' + requestId).update({
                status: 'accepted'
            });
            showNotification('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!');
        }

        function declineRequest(requestId) {
            database.ref('requests/' + requestId).update({
                status: 'declined'
            });
            showNotification('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
        }

        function startCall(userId) {
            showNotification('üìû –ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è... (—Å–∏–º—É–ª—è—Ü–∏—è)');
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω–∞—è WebRTC –ª–æ–≥–∏–∫–∞ –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤
        }

        function switchTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendRequest();
        });

        // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                database.ref('users/' + currentUser.id).update({
                    online: false,
                    lastSeen: Date.now()
                });
            }
        });
    </script>
</body>
</html>
