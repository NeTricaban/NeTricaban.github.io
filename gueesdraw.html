<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–≥–∞–¥–∞–π —Å–ª–æ–≤–æ - Draw & Guess</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: #24292e;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .game-area {
            display: grid;
            grid-template-columns: 2fr 1fr;
            height: 700px;
        }

        .drawing-section {
            padding: 20px;
            border-right: 1px solid #e1e4e8;
        }

        .canvas-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #drawingCanvas {
            background: white;
            border: 2px solid #e1e4e8;
            border-radius: 10px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
        }

        .tools {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn.active {
            border-color: #007bff;
        }

        .color-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.1);
        }

        .info-section {
            padding: 20px;
            background: #f6f8fa;
            display: flex;
            flex-direction: column;
        }

        .players-list {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e1e4e8;
        }

        .player {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }

        .player.drawing {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .player.guessed {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
        }

        .chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 10px;
            border: 1px solid #e1e4e8;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 300px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .message.system {
            background: #fff3cd;
            text-align: center;
            font-style: italic;
        }

        .message.correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #e1e4e8;
        }

        #messageInput {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        #messageInput:focus {
            border-color: #007bff;
        }

        .send-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            margin-left: 10px;
            cursor: pointer;
        }

        .game-controls {
            text-align: center;
            margin: 20px 0;
        }

        .word-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            color: #28a745;
            letter-spacing: 2px;
        }

        .timer {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            color: #dc3545;
        }

        .hidden {
            display: none;
        }

        .lobby {
            padding: 40px;
            text-align: center;
        }

        .room-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .room-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e4e8;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® –£–≥–∞–¥–∞–π —Å–ª–æ–≤–æ - Draw & Guess</h1>
            <p>–û–¥–∏–Ω —Ä–∏—Å—É–µ—Ç - –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–≥–∞–¥—ã–≤–∞—é—Ç!</p>
        </header>

        <div id="lobby" class="lobby">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É</h2>
            <div class="game-controls">
                <input type="text" id="roomName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" style="padding: 10px; margin: 10px;">
                <button onclick="createRoom()" class="send-btn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            </div>
            <div class="room-list" id="roomList">
                <!-- –ö–æ–º–Ω–∞—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>

        <div id="gameRoom" class="hidden">
            <div class="game-area">
                <div class="drawing-section">
                    <div class="timer" id="timer">–í—Ä–µ–º—è: 60 —Å–µ–∫</div>
                    <div class="word-display" id="wordDisplay">***</div>
                    
                    <div class="canvas-container">
                        <canvas id="drawingCanvas" width="700" height="400"></canvas>
                    </div>
                    
                    <div class="tools">
                        <button class="tool-btn" onclick="changeTool('brush')">üñåÔ∏è</button>
                        <button class="tool-btn" onclick="changeTool('eraser')">üßπ</button>
                        <button class="color-btn" style="background: #000;" onclick="changeColor('#000')"></button>
                        <button class="color-btn" style="background: #ff0000;" onclick="changeColor('#ff0000')"></button>
                        <button class="color-btn" style="background: #0000ff;" onclick="changeColor('#0000ff')"></button>
                        <button class="color-btn" style="background: #00ff00;" onclick="changeColor('#00ff00')"></button>
                        <button class="tool-btn" onclick="clearCanvas()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>

                <div class="info-section">
                    <div class="players-list">
                        <h3>üë• –ò–≥—Ä–æ–∫–∏</h3>
                        <div id="playersContainer">
                            <!-- –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ -->
                        </div>
                    </div>

                    <div class="chat">
                        <div class="messages" id="messages">
                            <div class="message system">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!</div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ...">
                            <button onclick="sendMessage()" class="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentRoom = null;
        let currentPlayer = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentColor = '#000000';
        let currentTool = 'brush';
        let canvas, ctx;

        // –°–ª–æ–≤–∞ –¥–ª—è –∏–≥—Ä—ã
        const wordList = [
            '—è–±–ª–æ–∫–æ', '–º–∞—à–∏–Ω–∞', '–¥–æ–º', '–∫–æ—à–∫–∞', '—Å–æ–±–∞–∫–∞', '—Å–æ–ª–Ω—Ü–µ', '–ª—É–Ω–∞',
            '–∫–Ω–∏–≥–∞', '–∫–æ–º–ø—å—é—Ç–µ—Ä', '—Ç–µ–ª–µ—Ñ–æ–Ω', '–¥–µ—Ä–µ–≤–æ', '—Ü–≤–µ—Ç–æ–∫', '–º–æ—Ä–µ',
            '–≥–æ—Ä—ã', '—Ä–µ–∫–∞', '—Å–∞–º–æ–ª–µ—Ç', '–ø–æ–µ–∑–¥', '–≤–µ–ª–æ—Å–∏–ø–µ–¥', '—á–∞—Å—ã'
        ];

        // –ò–º–∏—Ç–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ LocalStorage + Polling
        class GameServer {
            constructor() {
                this.rooms = JSON.parse(localStorage.getItem('drawguess_rooms')) || {};
                this.pollInterval = null;
                this.startPolling();
            }

            startPolling() {
                this.pollInterval = setInterval(() => {
                    this.checkForUpdates();
                }, 1000);
            }

            checkForUpdates() {
                const rooms = JSON.parse(localStorage.getItem('drawguess_rooms')) || {};
                if (currentRoom && rooms[currentRoom]) {
                    const updatedRoom = rooms[currentRoom];
                    this.handleRoomUpdate(updatedRoom);
                }
            }

            handleRoomUpdate(room) {
                if (room.canvas) {
                    this.redrawCanvas(room.canvas);
                }
                this.updatePlayers(room.players);
                this.updateChat(room.messages);
                this.updateGameState(room);
            }

            createRoom(name) {
                const roomId = 'room_' + Date.now();
                const room = {
                    id: roomId,
                    name: name,
                    players: [],
                    canvas: [],
                    messages: [],
                    currentWord: null,
                    drawer: null,
                    timeLeft: 60,
                    gameState: 'waiting'
                };
                
                this.rooms[roomId] = room;
                this.saveRooms();
                return roomId;
            }

            joinRoom(roomId, playerName) {
                const room = this.rooms[roomId];
                if (!room) return null;

                const player = {
                    id: 'player_' + Date.now(),
                    name: playerName,
                    score: 0,
                    isDrawing: false
                };

                room.players.push(player);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                room.messages.push({
                    type: 'system',
                    text: `${playerName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∏–≥—Ä–µ`
                });

                this.saveRooms();
                return player;
            }

            sendMessage(roomId, playerId, text) {
                const room = this.rooms[roomId];
                if (!room) return;

                const player = room.players.find(p => p.id === playerId);
                if (!player) return;

                room.messages.push({
                    player: player.name,
                    text: text,
                    type: 'chat'
                });

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≥–∞–¥–∞–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞
                if (room.gameState === 'drawing' && !player.isDrawing && room.currentWord) {
                    if (text.toLowerCase() === room.currentWord.toLowerCase()) {
                        player.score += 50;
                        room.messages.push({
                            type: 'system',
                            text: `üéâ ${player.name} —É–≥–∞–¥–∞–ª —Å–ª–æ–≤–æ "${room.currentWord}"!`
                        });
                    }
                }

                this.saveRooms();
            }

            draw(roomId, data) {
                const room = this.rooms[roomId];
                if (!room) return;

                room.canvas.push(data);
                this.saveRooms();
            }

            clearCanvas(roomId) {
                const room = this.rooms[roomId];
                if (!room) return;

                room.canvas = [];
                this.saveRooms();
            }

            saveRooms() {
                localStorage.setItem('drawguess_rooms', JSON.stringify(this.rooms));
            }

            getRooms() {
                return Object.values(this.rooms);
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è redrawCanvas, updatePlayers –∏ —Ç.–¥.
            redrawCanvas(canvasData) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvasData.forEach(draw => {
                    if (draw.type === 'line') {
                        ctx.beginPath();
                        ctx.moveTo(draw.startX, draw.startY);
                        ctx.lineTo(draw.endX, draw.endY);
                        ctx.strokeStyle = draw.color;
                        ctx.lineWidth = draw.width;
                        ctx.lineCap = 'round';
                        ctx.stroke();
                    }
                });
            }

            updatePlayers(players) {
                const container = document.getElementById('playersContainer');
                container.innerHTML = '';
                
                players.forEach(player => {
                    const playerEl = document.createElement('div');
                    playerEl.className = `player ${player.isDrawing ? 'drawing' : ''}`;
                    playerEl.innerHTML = `
                        <span>${player.name}</span>
                        <span>${player.score} –æ—á–∫–æ–≤</span>
                    `;
                    container.appendChild(playerEl);
                });
            }

            updateChat(messages) {
                const container = document.getElementById('messages');
                if (container.children.length === messages.length) return;

                container.innerHTML = '';
                messages.forEach(msg => {
                    const msgEl = document.createElement('div');
                    msgEl.className = `message ${msg.type === 'system' ? 'system' : ''}`;
                    msgEl.textContent = msg.player ? `${msg.player}: ${msg.text}` : msg.text;
                    container.appendChild(msgEl);
                });
                container.scrollTop = container.scrollHeight;
            }

            updateGameState(room) {
                document.getElementById('timer').textContent = `–í—Ä–µ–º—è: ${room.timeLeft} —Å–µ–∫`;
                
                if (room.drawer === currentPlayer?.id) {
                    document.getElementById('wordDisplay').textContent = room.currentWord;
                } else if (room.currentWord) {
                    document.getElementById('wordDisplay').textContent = '***';
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            setupCanvas();
            
            window.gameServer = new GameServer();
            updateRoomList();
        });

        function setupCanvas() {
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseout', endDraw);
        }

        function startDraw(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : currentColor;
            ctx.lineWidth = currentTool === 'eraser' ? 20 : 5;
            ctx.lineCap = 'round';
            ctx.stroke();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ "—Å–µ—Ä–≤–µ—Ä"
            if (currentRoom) {
                gameServer.draw(currentRoom, {
                    type: 'line',
                    startX: lastX,
                    startY: lastY,
                    endX: currentX,
                    endY: currentY,
                    color: currentTool === 'eraser' ? '#ffffff' : currentColor,
                    width: currentTool === 'eraser' ? 20 : 5
                });
            }

            lastX = currentX;
            lastY = currentY;
        }

        function endDraw() {
            isDrawing = false;
        }

        function changeTool(tool) {
            currentTool = tool;
        }

        function changeColor(color) {
            currentColor = color;
            currentTool = 'brush';
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (currentRoom) {
                gameServer.clearCanvas(currentRoom);
            }
        }

        function createRoom() {
            const roomName = document.getElementById('roomName').value || '–ö–æ–º–Ω–∞—Ç–∞ ' + Date.now();
            const roomId = gameServer.createRoom(roomName);
            
            const playerName = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:', '–ò–≥—Ä–æ–∫') || '–ò–≥—Ä–æ–∫';
            currentPlayer = gameServer.joinRoom(roomId, playerName);
            currentRoom = roomId;

            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameRoom').classList.remove('hidden');
        }

        function joinRoom(roomId) {
            const playerName = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:', '–ò–≥—Ä–æ–∫') || '–ò–≥—Ä–æ–∫';
            currentPlayer = gameServer.joinRoom(roomId, playerName);
            currentRoom = roomId;

            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameRoom').classList.remove('hidden');
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text && currentRoom && currentPlayer) {
                gameServer.sendMessage(currentRoom, currentPlayer.id, text);
                input.value = '';
            }
        }

        function updateRoomList() {
            const rooms = gameServer.getRooms();
            const container = document.getElementById('roomList');
            
            container.innerHTML = '';
            rooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card';
                roomCard.innerHTML = `
                    <h3>${room.name}</h3>
                    <p>–ò–≥—Ä–æ–∫–æ–≤: ${room.players.length}</p>
                `;
                roomCard.onclick = () => joinRoom(room.id);
                container.appendChild(roomCard);
            });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        setInterval(updateRoomList, 3000);
    </script>
</body>
</html>
