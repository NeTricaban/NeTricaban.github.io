<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TurtleBlocks 2025 - Визуальное программирование</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo img {
            width: 60px;
            height: 60px;
        }

        .logo h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .help-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
            height: calc(100vh - 150px);
        }

        .categories {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 15px;
            overflow-y: auto;
        }

        .category {
            margin-bottom: 20px;
        }

        .category h3 {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .blocks-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .block {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            user-select: none;
        }

        .block:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .workspace {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stage-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #stage {
            width: 100%;
            height: 100%;
            background: #fff;
            border-radius: 8px;
        }

        .code-area {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            min-height: 200px;
        }

        .code-line {
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: move;
            user-select: none;
            position: relative;
        }

        .code-line .delete-btn {
            position: absolute;
            right: 10px;
            background: rgba(255, 0, 0, 0.3);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .code-line .delete-btn:hover {
            background: rgba(255, 0, 0, 0.5);
        }

        .code-line.dragging {
            opacity: 0.5;
        }

        .properties {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 15px;
            overflow-y: auto;
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-group h3 {
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #ffcc00;
        }

        .property {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }

        .property label {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .property input, .property select {
            padding: 8px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .property input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .turtle {
            position: absolute;
            width: 80px;
            height: 80px;
            transition: transform 0.3s;
            pointer-events: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            padding: 30px;
            border-radius: 15px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
            color: #ffcc00;
        }

        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
        }

        footer {
            text-align: center;
            padding: 20px 0;
            margin-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .block-input {
            width: 50px;
            padding: 2px 5px;
            border: none;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
        }

        .block-drop-zone {
            min-height: 50px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 5px 0;
            padding: 10px;
            transition: all 0.2s;
        }

        .block-drop-zone.active {
            border-color: #ffcc00;
            background: rgba(255, 204, 0, 0.1);
        }

        .sensor-value {
            background: rgba(0, 255, 0, 0.2);
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-left: 10px;
        }

        .program-stats {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
            }
            
            .categories, .properties {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="https://i0.wp.com/gas-kvas.com/grafic/uploads/posts/2024-01/gas-kvas-com-p-cherepakha-dlya-detei-na-prozrachnom-fone-4.png?ssl=1" alt="TurtleBlocks Logo">
                <h1>TurtleBlocks 2025</h1>
            </div>
            <button class="help-btn" id="help-btn">
                <span>❓ Помощь</span>
            </button>
        </header>

        <div class="main-content">
            <div class="categories">
                <div class="category">
                    <h3>🚀 Движение</h3>
                    <div class="blocks-container">
                        <div class="block" data-type="move" data-params="steps">
                            <div>Идти <input type="number" class="block-input" value="10" data-param="steps"> шагов</div>
                        </div>
                        <div class="block" data-type="turn" data-params="degrees">
                            <div>Повернуть ↻ <input type="number" class="block-input" value="15" data-param="degrees">°</div>
                        </div>
                        <div class="block" data-type="turn-left" data-params="degrees">
                            <div>Повернуть ↺ <input type="number" class="block-input" value="15" data-param="degrees">°</div>
                        </div>
                        <div class="block" data-type="goto" data-params="x,y">
                            <div>Перейти в x:<input type="number" class="block-input" value="0" data-param="x"> y:<input type="number" class="block-input" value="0" data-param="y"></div>
                        </div>
                        <div class="block" data-type="point-direction" data-params="direction">
                            <div>Направиться в <input type="number" class="block-input" value="90" data-param="direction">°</div>
                        </div>
                    </div>
                </div>
                
                <div class="category">
                    <h3>🎨 Внешний вид</h3>
                    <div class="blocks-container">
                        <div class="block" data-type="say" data-params="text">
                            <div>Сказать <input type="text" class="block-input" value="Привет!" data-param="text"></div>
                        </div>
                        <div class="block" data-type="think" data-params="text">
                            <div>Думать <input type="text" class="block-input" value="О чем-то" data-param="text"></div>
                        </div>
                        <div class="block" data-type="show">Показаться</div>
                        <div class="block" data-type="hide">Спрятаться</div>
                        <div class="block" data-type="size" data-params="size">
                            <div>Изменить размер на <input type="number" class="block-input" value="10" data-param="size"></div>
                        </div>
                    </div>
                </div>
                
                <div class="category">
                    <h3>✏️ Перо</h3>
                    <div class="blocks-container">
                        <div class="block" data-type="pen-down">Опустить перо</div>
                        <div class="block" data-type="pen-up">Поднять перо</div>
                        <div class="block" data-type="pen-color" data-params="color">
                            <div>Цвет пера <input type="color" class="block-input" value="#ff0000" data-param="color"></div>
                        </div>
                        <div class="block" data-type="pen-size" data-params="size">
                            <div>Размер пера <input type="number" class="block-input" value="2" data-param="size"></div>
                        </div>
                        <div class="block" data-type="stamp">Штамп</div>
                        <div class="block" data-type="clear">Очистить</div>
                    </div>
                </div>
                
                <div class="category">
                    <h3>🎵 Звук</h3>
                    <div class="blocks-container">
                        <div class="block" data-type="play-sound">Играть звук</div>
                        <div class="block" data-type="stop-sound">Остановить все звуки</div>
                        <div class="block" data-type="beep">Издать звук</div>
                        <div class="block" data-type="play-note" data-params="note">
                            <div>Играть ноту <input type="number" class="block-input" value="60" data-param="note"></div>
                        </div>
                    </div>
                </div>
                
                <div class="category">
                    <h3>🕹️ Управление</h3>
                    <div class="blocks-container">
                        <div class="block" data-type="when-flag-clicked">Когда щелкнут по флагу</div>
                        <div class="block" data-type="when-clicked">Когда щелкнут по черепахе</div>
                        <div class="block" data-type="when-key" data-params="key">
                            <div>Когда нажата клавиша <input type="text" class="block-input" value="пробел" data-param="key"></div>
                        </div>
                        <div class="block" data-type="forever">Повторять всегда</div>
                        <div class="block" data-type="repeat" data-params="times">
                            <div>Повторить <input type="number" class="block-input" value="10" data-param="times"> раз</div>
                        </div>
                        <div class="block" data-type="wait" data-params="secs">
                            <div>Ждать <input type="number" class="block-input" value="1" data-param="secs"> секунд</div>
                        </div>
                    </div>
                </div>
                
                <div class="category">
                    <h3>🎯 Сенсоры</h3>
                    <div class="blocks-container">
                        <div class="block" data-type="touching-edge">Касается края?</div>
                        <div class="block" data-type="mouse-x">Координата X мыши</div>
                        <div class="block" data-type="mouse-y">Координата Y мыши</div>
                        <div class="block" data-type="key-pressed" data-params="key">
                            <div>Клавиша <input type="text" class="block-input" value="пробел" data-param="key"> нажата?</div>
                        </div>
                        <div class="block" data-type="distance-to-mouse">Расстояние до мыши</div>
                        <div class="block" data-type="timer">Таймер</div>
                    </div>
                </div>
                
                <div class="category">
                    <h3>🔧 Дополнительные блоки</h3>
                    <div class="blocks-container">
                        <div class="block" data-type="chase-mouse">Преследовать мышь</div>
                        <div class="block" data-type="wasd-controls">Управление WASD</div>
                        <div class="block" data-type="draw-square">Нарисовать квадрат</div>
                        <div class="block" data-type="draw-circle">Нарисовать круг</div>
                        <div class="block" data-type="draw-star">Нарисовать звезду</div>
                        <div class="block" data-type="spiral">Нарисовать спираль</div>
                    </div>
                </div>

                <div class="program-stats">
                    <div>Блоков в программе: <span id="block-count">0</span></div>
                    <div>Примеры программ: Квадрат, Спираль, Звезда</div>
                </div>
            </div>

            <div class="workspace">
                <div class="stage-container">
                    <canvas id="stage" width="800" height="500"></canvas>
                    <img src="https://i0.wp.com/gas-kvas.com/grafic/uploads/posts/2024-01/gas-kvas-com-p-cherepakha-dlya-detei-na-prozrachnom-fone-4.png?ssl=1" alt="Turtle" class="turtle" id="turtle">
                    <div id="speech-bubble" style="display: none; position: absolute; background: white; color: black; padding: 10px; border-radius: 10px; max-width: 200px; font-size: 14px;"></div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" id="run-btn">
                        <span>▶ Запуск</span>
                    </button>
                    <button class="btn btn-secondary" id="stop-btn">
                        <span>⏹ Стоп</span>
                    </button>
                    <button class="btn btn-secondary" id="clear-btn">
                        <span>🗑 Очистить</span>
                    </button>
                    <button class="btn btn-secondary" id="upload-btn">
                        <span>📁 Загрузить изображение</span>
                    </button>
                    <button class="btn btn-secondary" id="example-btn">
                        <span>📋 Примеры</span>
                    </button>
                </div>
                <div class="code-area" id="code-area">
                    <div class="block-drop-zone" id="main-drop-zone">
                        Нажмите на блоки слева, чтобы добавить их в программу
                    </div>
                </div>
            </div>

            <div class="properties">
                <div class="property-group">
                    <h3>🐢 Свойства черепахи</h3>
                    <div class="property">
                        <label for="turtle-x">Позиция X: <span id="turtle-x-value">400</span></label>
                        <input type="range" id="turtle-x" min="0" max="800" value="400">
                    </div>
                    <div class="property">
                        <label for="turtle-y">Позиция Y: <span id="turtle-y-value">250</span></label>
                        <input type="range" id="turtle-y" min="0" max="500" value="250">
                    </div>
                    <div class="property">
                        <label for="turtle-direction">Направление: <span id="turtle-direction-value">90</span>°</label>
                        <input type="range" id="turtle-direction" min="0" max="360" value="90">
                    </div>
                    <div class="property">
                        <label for="turtle-size">Размер: <span id="turtle-size-value">80</span>px</label>
                        <input type="range" id="turtle-size" min="20" max="150" value="80">
                    </div>
                    <div class="property">
                        <label for="turtle-visible">Видимость:</label>
                        <select id="turtle-visible">
                            <option value="true">Видимый</option>
                            <option value="false">Скрытый</option>
                        </select>
                    </div>
                </div>
                
                <div class="property-group">
                    <h3>✏️ Свойства пера</h3>
                    <div class="property">
                        <label for="pen-color">Цвет пера:</label>
                        <input type="color" id="pen-color" value="#ff0000">
                    </div>
                    <div class="property">
                        <label for="pen-size">Размер пера: <span id="pen-size-value">2</span></label>
                        <input type="range" id="pen-size" min="1" max="20" value="2">
                    </div>
                    <div class="property">
                        <label for="pen-down">Состояние пера:</label>
                        <select id="pen-down">
                            <option value="true">Опущено</option>
                            <option value="false">Поднято</option>
                        </select>
                    </div>
                </div>
                
                <div class="property-group">
                    <h3>🎵 Звук</h3>
                    <div class="property">
                        <label for="sound-volume">Громкость: <span id="sound-volume-value">50</span>%</label>
                        <input type="range" id="sound-volume" min="0" max="100" value="50">
                    </div>
                </div>
                
                <div class="property-group">
                    <h3>📊 Сенсоры</h3>
                    <div class="property">
                        <label>Координата X: <span class="sensor-value" id="sensor-x">400</span></label>
                    </div>
                    <div class="property">
                        <label>Координата Y: <span class="sensor-value" id="sensor-y">250</span></label>
                    </div>
                    <div class="property">
                        <label>Направление: <span class="sensor-value" id="sensor-direction">90°</span></label>
                    </div>
                    <div class="property">
                        <label>Таймер: <span class="sensor-value" id="sensor-timer">0.0</span> сек</label>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-primary" id="save-project">Сохранить проект</button>
                    <button class="btn btn-secondary" id="load-project">Загрузить проект</button>
                    <button class="btn btn-secondary" id="reset-btn">Сбросить всё</button>
                </div>
            </div>
        </div>

        <footer>
            <p>TurtleBlocks &copy; 2025 - Визуальная среда программирования для всех возрастов</p>
        </footer>
    </div>

    <!-- Модальное окно для загрузки изображений -->
    <div class="modal" id="upload-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-upload-modal">&times;</span>
            <h2>Загрузить изображение</h2>
            <div class="property">
                <label for="image-url">URL изображения:</label>
                <input type="text" id="image-url" placeholder="Введите URL изображения">
            </div>
            <div class="property">
                <label for="image-file">Или выберите файл:</label>
                <input type="file" id="image-file" accept="image/*">
            </div>
            <div class="buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" id="confirm-upload">Загрузить</button>
                <button class="btn btn-secondary" id="cancel-upload">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно помощи -->
    <div class="modal" id="help-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-help-modal">&times;</span>
            <h2>Как использовать TurtleBlocks 2025</h2>
            <div style="max-height: 400px; overflow-y: auto;">
                <h3>Создание программы:</h3>
                <p>1. <strong>Нажмите на блоки</strong> в левой панели, чтобы добавить их в программу</p>
                <p>2. <strong>Настройте параметры</strong> блоков (числа, текст, цвета)</p>
                <p>3. <strong>Нажмите "Запуск"</strong> чтобы выполнить программу</p>
                
                <h3>Управление программой:</h3>
                <p>• Перетаскивайте блоки для изменения порядка</p>
                <p>• Нажмите ❌ чтобы удалить блок</p>
                <p>• Используйте "Примеры" для быстрого старта</p>
                
                <h3>Примеры программ:</h3>
                <p><strong>Квадрат:</strong> "Когда щелкнут по флагу" → "Повторить 4 раза" → "Идти 100 шагов" → "Повернуть ↻ 90°"</p>
                <p><strong>Спираль:</strong> "Когда щелкнут по флагу" → "Повторять всегда" → "Идти 10 шагов" → "Повернуть ↻ 89°"</p>
                <p><strong>Звезда:</strong> Используйте блок "Нарисовать звезду"</p>
                
                <h3>Сенсоры:</h3>
                <p>Используйте блоки сенсоров для взаимодействия с мышью и клавиатурой</p>
            </div>
            <div class="buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" id="close-help">Понятно</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно примеров -->
    <div class="modal" id="examples-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-examples-modal">&times;</span>
            <h2>Примеры программ</h2>
            <div style="max-height: 400px; overflow-y: auto;">
                <div class="buttons">
                    <button class="btn btn-primary example-program" data-example="square">Квадрат</button>
                    <button class="btn btn-primary example-program" data-example="spiral">Спираль</button>
                    <button class="btn btn-primary example-program" data-example="star">Звезда</button>
                    <button class="btn btn-primary example-program" data-example="circle">Круг</button>
                </div>
                <div id="example-description" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                    Выберите пример программы для загрузки
                </div>
            </div>
            <div class="buttons" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="close-examples">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        // Основные переменные
        const stage = document.getElementById('stage');
        const ctx = stage.getContext('2d');
        const turtle = document.getElementById('turtle');
        const codeArea = document.getElementById('code-area');
        const runBtn = document.getElementById('run-btn');
        const stopBtn = document.getElementById('stop-btn');
        const clearBtn = document.getElementById('clear-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const exampleBtn = document.getElementById('example-btn');
        const helpBtn = document.getElementById('help-btn');
        const resetBtn = document.getElementById('reset-btn');
        const uploadModal = document.getElementById('upload-modal');
        const helpModal = document.getElementById('help-modal');
        const examplesModal = document.getElementById('examples-modal');
        
        // Позиция и состояние черепахи
        let turtleX = stage.width / 2;
        let turtleY = stage.height / 2;
        let turtleDirection = 90;
        let penDown = true;
        let penColor = '#ff0000';
        let penSize = 2;
        let isRunning = false;
        let timerStart = 0;
        
        // Инициализация
        function init() {
            resetStage();
            updateTurtlePosition();
            
            // Обработчики для блоков - теперь по клику
            document.querySelectorAll('.block').forEach(block => {
                block.addEventListener('click', handleBlockClick);
            });
            
            // Обработчики кнопок
            runBtn.addEventListener('click', runCode);
            stopBtn.addEventListener('click', stopCode);
            clearBtn.addEventListener('click', clearCode);
            uploadBtn.addEventListener('click', () => uploadModal.style.display = 'flex');
            exampleBtn.addEventListener('click', () => examplesModal.style.display = 'flex');
            helpBtn.addEventListener('click', () => helpModal.style.display = 'flex');
            resetBtn.addEventListener('click', resetAll);
            
            // Обработчики модальных окон
            document.getElementById('close-upload-modal').addEventListener('click', () => uploadModal.style.display = 'none');
            document.getElementById('cancel-upload').addEventListener('click', () => uploadModal.style.display = 'none');
            document.getElementById('confirm-upload').addEventListener('click', uploadImage);
            document.getElementById('close-help-modal').addEventListener('click', () => helpModal.style.display = 'none');
            document.getElementById('close-help').addEventListener('click', () => helpModal.style.display = 'none');
            document.getElementById('close-examples-modal').addEventListener('click', () => examplesModal.style.display = 'none');
            document.getElementById('close-examples').addEventListener('click', () => examplesModal.style.display = 'none');
            
            // Обработчики примеров программ
            document.querySelectorAll('.example-program').forEach(btn => {
                btn.addEventListener('click', loadExampleProgram);
            });
            
            // Обработчики свойств
            document.getElementById('turtle-x').addEventListener('input', updateTurtleFromProperties);
            document.getElementById('turtle-y').addEventListener('input', updateTurtleFromProperties);
            document.getElementById('turtle-direction').addEventListener('input', updateTurtleFromProperties);
            document.getElementById('turtle-size').addEventListener('input', updateTurtleFromProperties);
            document.getElementById('turtle-visible').addEventListener('change', updateTurtleFromProperties);
            document.getElementById('pen-color').addEventListener('input', updatePenFromProperties);
            document.getElementById('pen-size').addEventListener('input', updatePenFromProperties);
            document.getElementById('pen-down').addEventListener('change', updatePenFromProperties);
            document.getElementById('sound-volume').addEventListener('input', updateSoundFromProperties);
            
            // Обработчики сенсоров
            stage.addEventListener('mousemove', updateMouseSensors);
            document.addEventListener('keydown', handleKeyDown);
            
            // Запуск таймера для обновления сенсоров
            timerStart = Date.now();
            setInterval(updateSensors, 100);
            
            updateBlockCount();
        }
        
        // Обработчик клика по блоку
        function handleBlockClick(e) {
            const block = e.currentTarget;
            const type = block.dataset.type;
            const params = {};
            
            // Собираем параметры из input'ов
            if (block.hasAttribute('data-params')) {
                const paramNames = block.dataset.params.split(',');
                paramNames.forEach(param => {
                    const input = block.querySelector(`[data-param="${param}"]`);
                    if (input) {
                        params[param] = input.type === 'number' ? parseInt(input.value) : input.value;
                    }
                });
            }
            
            addBlockToProgram(type, params);
        }
        
        // Добавление блока в программу
        function addBlockToProgram(type, params = {}) {
            const dropZone = document.getElementById('main-drop-zone');
            
            // Если зона содержит только текст-подсказку, очищаем её
            if (dropZone.children.length === 1 && !dropZone.children[0].classList.contains('code-line')) {
                dropZone.innerHTML = '';
            }
            
            const codeBlock = createCodeBlock(type, params);
            dropZone.appendChild(codeBlock);
            updateBlockCount();
        }
        
        // Создание блока кода
        function createCodeBlock(type, params = {}) {
            const block = document.createElement('div');
            block.className = 'code-line';
            block.draggable = true;
            block.dataset.type = type;
            
            let html = '';
            switch(type) {
                case 'when-flag-clicked':
                    html = 'Когда щелкнут по флагу';
                    break;
                case 'when-clicked':
                    html = 'Когда щелкнут по черепахе';
                    break;
                case 'when-key':
                    html = `Когда нажата клавиша <input type="text" class="block-input" value="${params.key || 'пробел'}" data-param="key">`;
                    break;
                case 'forever':
                    html = 'Повторять всегда';
                    break;
                case 'repeat':
                    html = `Повторить <input type="number" class="block-input" value="${params.times || 10}" data-param="times"> раз`;
                    break;
                case 'wait':
                    html = `Ждать <input type="number" class="block-input" value="${params.secs || 1}" data-param="secs"> секунд`;
                    break;
                case 'move':
                    html = `Идти <input type="number" class="block-input" value="${params.steps || 10}" data-param="steps"> шагов`;
                    break;
                case 'turn':
                    html = `Повернуть ↻ <input type="number" class="block-input" value="${params.degrees || 15}" data-param="degrees">°`;
                    break;
                case 'turn-left':
                    html = `Повернуть ↺ <input type="number" class="block-input" value="${params.degrees || 15}" data-param="degrees">°`;
                    break;
                case 'goto':
                    html = `Перейти в x:<input type="number" class="block-input" value="${params.x || 0}" data-param="x"> y:<input type="number" class="block-input" value="${params.y || 0}" data-param="y">`;
                    break;
                case 'point-direction':
                    html = `Направиться в <input type="number" class="block-input" value="${params.direction || 90}" data-param="direction">°`;
                    break;
                case 'say':
                    html = `Сказать <input type="text" class="block-input" value="${params.text || 'Привет!'}" data-param="text">`;
                    break;
                case 'think':
                    html = `Думать <input type="text" class="block-input" value="${params.text || 'О чем-то'}" data-param="text">`;
                    break;
                case 'show':
                    html = 'Показаться';
                    break;
                case 'hide':
                    html = 'Спрятаться';
                    break;
                case 'size':
                    html = `Изменить размер на <input type="number" class="block-input" value="${params.size || 10}" data-param="size">`;
                    break;
                case 'pen-down':
                    html = 'Опустить перо';
                    break;
                case 'pen-up':
                    html = 'Поднять перо';
                    break;
                case 'pen-color':
                    html = `Цвет пера <input type="color" class="block-input" value="${params.color || '#ff0000'}" data-param="color">`;
                    break;
                case 'pen-size':
                    html = `Размер пера <input type="number" class="block-input" value="${params.size || 2}" data-param="size">`;
                    break;
                case 'stamp':
                    html = 'Штамп';
                    break;
                case 'clear':
                    html = 'Очистить';
                    break;
                case 'play-sound':
                    html = 'Играть звук';
                    break;
                case 'stop-sound':
                    html = 'Остановить все звуки';
                    break;
                case 'beep':
                    html = 'Издать звук';
                    break;
                case 'play-note':
                    html = `Играть ноту <input type="number" class="block-input" value="${params.note || 60}" data-param="note">`;
                    break;
                case 'draw-square':
                    html = 'Нарисовать квадрат';
                    break;
                case 'draw-circle':
                    html = 'Нарисовать круг';
                    break;
                case 'draw-star':
                    html = 'Нарисовать звезду';
                    break;
                case 'spiral':
                    html = 'Нарисовать спираль';
                    break;
                case 'chase-mouse':
                    html = 'Преследовать мышь';
                    break;
                case 'wasd-controls':
                    html = 'Управление WASD';
                    break;
                default:
                    html = 'Неизвестный блок';
            }
            
            html += '<button class="delete-btn">❌</button>';
            block.innerHTML = html;
            
            // Обработчики для блока
            block.addEventListener('dragstart', handleCodeBlockDragStart);
            block.addEventListener('dragover', handleCodeBlockDragOver);
            block.addEventListener('drop', handleCodeBlockDrop);
            block.querySelector('.delete-btn').addEventListener('click', function() {
                block.remove();
                updateBlockCount();
            });
            
            return block;
        }
        
        // Загрузка примера программы
        function loadExampleProgram(e) {
            const example = e.currentTarget.dataset.example;
            const dropZone = document.getElementById('main-drop-zone');
            dropZone.innerHTML = '';
            
            let description = '';
            
            switch(example) {
                case 'square':
                    addBlockToProgram('when-flag-clicked');
                    addBlockToProgram('repeat', {times: 4});
                    addBlockToProgram('move', {steps: 100});
                    addBlockToProgram('turn', {degrees: 90});
                    description = 'Рисует квадрат со стороной 100 шагов';
                    break;
                    
                case 'spiral':
                    addBlockToProgram('when-flag-clicked');
                    addBlockToProgram('forever');
                    addBlockToProgram('move', {steps: 10});
                    addBlockToProgram('turn', {degrees: 89});
                    description = 'Рисует бесконечную спираль';
                    break;
                    
                case 'star':
                    addBlockToProgram('when-flag-clicked');
                    addBlockToProgram('draw-star');
                    description = 'Рисует звезду';
                    break;
                    
                case 'circle':
                    addBlockToProgram('when-flag-clicked');
                    addBlockToProgram('draw-circle');
                    description = 'Рисует круг';
                    break;
            }
            
            document.getElementById('example-description').textContent = description;
            examplesModal.style.display = 'none';
        }
        
        // Остальные функции остаются такими же, как в предыдущей версии
        // (resetStage, updateTurtlePosition, moveTurtle, turnTurtle, runCode, stopCode, clearCode, etc.)
        
        // Обновление счетчика блоков
        function updateBlockCount() {
            const blockCount = document.querySelectorAll('.code-line').length;
            document.getElementById('block-count').textContent = blockCount;
        }
        
        // Сброс всего
        function resetAll() {
            clearCode();
            resetStage();
            turtleX = stage.width / 2;
            turtleY = stage.height / 2;
            turtleDirection = 90;
            updateTurtlePosition();
        }
        
        // Инициализация при загрузке страницы
        window.onload = init;
    </script>
</body>
</html>
